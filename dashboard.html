<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard — Universidade HS</title>
  <style>
    :root{--bg:#0f172a;--card:#111827;--fg:#e5e7eb;--muted:#94a3b8}
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--fg)}
    .wrap{max-width:1200px;margin:0 auto;padding:20px}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid #1f2937;background:var(--card);padding:10px 14px;border-radius:12px;text-decoration:none;cursor:pointer}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #1f2937;text-align:left}
    .muted{color:var(--muted)}
    .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:12px}
    .kpi{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:12px}
    .kpi .v{font-weight:800;font-size:22px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <h1>Dashboard — Visualizações</h1>
      <div>
        <a class="btn" href="/">← Voltar</a>
      </div>
    </div>
    <p class="muted">Faça login. Gestor/Gerente vê todos; demais, apenas seus dados.</p>

    <div class="kpis">
      <div class="kpi">Tempo total <div id="k_total" class="v">00:00:00</div></div>
      <div class="kpi">Utilizadores <div id="k_users" class="v">0</div></div>
      <div class="kpi">Vídeos assistidos <div id="k_videos" class="v">0</div></div>
    </div>

    <table id="tbl">
      <thead><tr><th>Utilizador</th><th>Vídeo</th><th>Tempo assistido</th><th>Último acesso</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <script>
  const API = '/.netlify/functions'
  const tbl = document.querySelector('#tbl tbody')
  const kTotal = document.getElementById('k_total')
  const kUsers = document.getElementById('k_users')
  const kVideos = document.getElementById('k_videos')

  function fmt(sec){
    sec = Math.round(Number(sec||0));
    const h = Math.floor(sec/3600), m = Math.floor((sec%3600)/60), s = sec%60;
    return [h,m,s].map(x=>String(x).padStart(2,'0')).join(':')
  }

  function render(rows){
    // KPIs
    const total = rows.reduce((s,r)=>s+Number(r.seconds||0),0)
    const users = new Set(rows.map(r=>r.user_email||'—'))
    const videos = new Set(rows.map(r=>r.video_id))
    kTotal.textContent = fmt(total)
    kUsers.textContent = String(users.size)
    kVideos.textContent = String(videos.size)

    // tabela
    tbl.innerHTML = rows.map(r => {
      return `<tr>
        <td>${r.user_email || '—'}</td>
        <td>${r.video_title || r.video_id}</td>
        <td>${fmt(r.seconds)}</td>
        <td>${r.last_seen ? new Date(r.last_seen).toLocaleString() : '—'}</td>
      </tr>`
    }).join('')
  }

  async function load(){
    const user = netlifyIdentity.currentUser()
    if(!user){ netlifyIdentity.open('login'); return }
    const token = await user.jwt()
    const res = await fetch(API + '/dashboard', { headers: { Authorization: 'Bearer '+token }})
    const data = await res.json().catch(()=>({rows:[]}))
    render(data.rows || [])
  }

  netlifyIdentity.on('login', load)
  netlifyIdentity.init()
  load()
  </script>
</body>
</html>
