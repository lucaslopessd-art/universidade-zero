<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Universidade HS — Dashboard</title>
  <style>
    :root{--bg:#0f172a;--card:#111827;--fg:#e5e7eb;--muted:#94a3b8}
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--fg)}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:16px;margin:12px 0}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 10px;border-bottom:1px solid #1f2937;text-align:left;font-size:14px}
    .muted{color:var(--muted)}
    .btn{display:inline-flex;align-items:center;gap:8px;background:#fff;color:#111;border:1px solid #e5e7eb;border-radius:12px;padding:10px 14px;cursor:pointer}
    .btn:hover{background:#f1f5f9}
    .hide{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Dashboard</h1>
    <p class="muted">Somente administradores.</p>

    <div id="msg" class="card">Validando acesso…</div>
    <div id="loginBox" class="card hide">
      <div style="display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap">
        <span>Faça login para continuar.</span>
        <button id="openLogin" class="btn">Entrar com Google</button>
      </div>
    </div>

    <div id="pane" class="card" style="display:none">
      <div id="kpis" class="muted" style="margin-bottom:10px"></div>
      <table id="t"><thead>
        <tr><th>Usuário</th><th>Vídeos concluídos</th></tr>
      </thead><tbody></tbody></table>
    </div>
  </div>

  <!-- Netlify Identity -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <script>
    const IDENTITY_URL = `${location.origin}/.netlify/identity`;

    // Espera robusta pelo usuário (init + login + polling)
    function waitForUser(timeoutMs = 8000) {
      return new Promise(resolve => {
        let done = false;

        function finish(u){ if(!done){ done = true; resolve(u||null);} }

        // init com usuário (ou null)
        window.netlifyIdentity?.on?.('init', (u) => finish(u));

        // se fizer login depois
        window.netlifyIdentity?.on?.('login', (u) => finish(u));

        // polling leve
        const iv = setInterval(() => {
          const u = window.netlifyIdentity?.currentUser?.();
          if (u) { clearInterval(iv); clearTimeout(to); finish(u); }
        }, 200);

        // timeout
        const to = setTimeout(() => { clearInterval(iv); finish(null); }, timeoutMs);

        // tentativa imediata
        const u0 = window.netlifyIdentity?.currentUser?.();
        if (u0) { clearInterval(iv); clearTimeout(to); finish(u0); }
      });
    }

    async function main(){
      try {
        window.netlifyIdentity?.init({ APIUrl: IDENTITY_URL });

        const user = await waitForUser();

        if (!user) {
          document.getElementById('msg').classList.add('hide');
          document.getElementById('loginBox').classList.remove('hide');
          document.getElementById('openLogin').onclick = () => window.netlifyIdentity?.open?.();
          return;
        }

        // Pega token e chama a função com header extra de e-mail (fallback)
        const token = await user.jwt();
        const res = await fetch('/.netlify/functions/dashboard', {
          headers: {
            Authorization: 'Bearer ' + token,
            'x-user-email': user.email?.toLowerCase() || ''
          }
        });

        if (res.status === 403) {
          document.getElementById('msg').textContent = 'Acesso negado.';
          return;
        }
        if (!res.ok) {
          document.getElementById('msg').textContent = 'Erro ao carregar.';
          return;
        }

        const data = await res.json();

        // Exibe KPIs simples do resumo
        document.getElementById('msg').style.display='none';
        const pane = document.getElementById('pane'); pane.style.display='block';
        const k = document.getElementById('kpis');
        if (data.totalUsers != null && data.totalViews != null) {
          k.textContent = `Total de usuários: ${data.totalUsers} • Total de vídeos finalizados: ${data.totalViews}`;
        }

        // Monta ranking (ou lista)
        const tbody = document.querySelector('#t tbody');
        const rows = (data.ranking || Object.values(data.users||{}))
          .map(u => `<tr><td>${u.email}</td><td>${u.completed ?? u.videos?.length ?? 0}</td></tr>`);
        tbody.innerHTML = rows.join('');
      } catch (e) {
        document.getElementById('msg').textContent = 'Erro ao carregar.';
      }
    }
    main();
  </script>
</body>
</html>
